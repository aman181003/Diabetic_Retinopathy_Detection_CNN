<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DR-Assist — Clinical Screening</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet"/>
</head>
<body class="bg-body text-dark">
<nav class="navbar navbar-expand-lg navbar-light shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
            <div class="brand-mark me-2">DR</div>
            <div>
                <div style="font-size:1rem; line-height: 1.2;">DR-Assist</div>
                <small class="text-muted fw-normal" style="font-size: 0.75rem;">AI-Assisted Retinal Screening</small>
            </div>
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="#" data-page="analyze">Analyze</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-page="reports">Reports</a></li>
                <li class="nav-item"><a class="nav-link" href="#" data-page="learn">Learn</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container my-5">
    <div id="page-analyze" class="page active-page">
        <div class="row g-4">
            <!-- LEFT: Upload + settings -->
            <div class="col-xl-3 col-md-4">
                <div class="left-sidebar-sticky">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Patient & Image Details</h5>
                            <p class="text-muted small">Upload a fundus photo and fill in patient information for the report.</p>

                            <form id="uploadForm">
                                <!-- Image Upload -->
                                <div class="mb-3">
                                    <label for="fileInput" class="form-label small fw-bold">Fundus Photo</label>
                                    <input id="fileInput" name="file" class="form-control" type="file" accept="image/*" required>
                                </div>
                                <hr>
                                <!-- Patient Details -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Patient Information</label>
                                    <input name="patient_name" class="form-control form-control-sm mb-2" placeholder="Patient Full Name" type="text" required>
                                    <input name="patient_id" class="form-control form-control-sm mb-2" placeholder="Patient ID / MRN" type="text">
                                    <div class="d-flex gap-2 mb-2">
                                        <input name="patient_age" class="form-control form-control-sm" placeholder="Age" type="number" min="0">
                                        <select name="patient_sex" class="form-select form-select-sm"><option value="">Sex</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select>
                                    </div>
                                </div>
                                <!-- Clinical Details -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Clinical Data</label>
                                    <div class="d-flex gap-2 mb-2">
                                        <select name="laterality" class="form-select form-select-sm"><option value="">Laterality</option><option value="OD">OD (Right Eye)</option><option value="OS">OS (Left Eye)</option></select>
                                        <input name="diabetes_duration_years" class="form-control form-control-sm" placeholder="Diabetes (yrs)" type="number" min="0">
                                    </div>
                                    <input name="visual_acuity" class="form-control form-control-sm" placeholder="Visual Acuity (e.g., 20/40)">
                                </div>
                                <div class="d-grid mt-4">
                                    <button id="analyzeBtn" type="submit" class="btn btn-primary"><i class="bi bi-magic me-2"></i>Analyze & Generate Report</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="card-title">Triage Legend</h6>
                            <div class="d-flex flex-column gap-2 mt-3">
                                <div class="triage-chip routine">Routine &mdash; 6–12 mo</div>
                                <div class="triage-chip expedited">Expedited &mdash; 2–4 wk</div>
                                <div class="triage-chip urgent">Urgent &mdash; ≤1 wk</div>
                                <div class="triage-chip emergency">Emergency &mdash; 48 hrs</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CENTER: Results -->
            <div class="col-xl-6 col-md-8">
                <div id="resultsContainer" class="position-relative">
                    <div id="loadingSpinner" class="spinner-container">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Analyzing...</span></div>
                    </div>
                    <div id="resultsCard" class="card" style="visibility:hidden;"></div>
                    <div id="placeholderCard" class="card p-5 text-center">
                        <div class="card-body">
                            <div class="mb-3"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg></div>
                            <h5 class="mb-1">Ready to Analyze</h5>
                            <p class="text-muted small mb-0">Upload an image and patient details to begin the AI-powered screening process.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Interpretation Guide -->
            <div class="col-xl-3 d-none d-xl-block">
                <div id="contextual-sidebar">
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="text-center small text-muted py-4">
    DR-Assist • For decision-support only. Not a substitute for professional medical advice.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const form = document.getElementById('uploadForm');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultsCard = document.getElementById('resultsCard');
    const placeholderCard = document.getElementById('placeholderCard');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const contextualSidebar = document.getElementById('contextual-sidebar');
    const originalBtnHTML = analyzeBtn.innerHTML;

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        if (!formData.get('file')?.size) { alert('Please select an image file to analyze.'); return; }

        // --- Set Loading State ---
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...`;
        placeholderCard.style.display = 'none';
        resultsCard.style.visibility = 'hidden';
        resultsCard.classList.remove('visible');
        contextualSidebar.innerHTML = ''; // Clear sidebar
        loadingSpinner.classList.add('visible');

        try {
            const response = await fetch('/predict', {method: 'POST', body: formData});
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Analysis failed: ${errorText}`);
            }
            const data = await response.json();
            updateUI(data);
        } catch (err) {
            console.error(err);
            alert(err.message);
            placeholderCard.style.display = '';
        } finally {
            // --- Reset UI State ---
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = originalBtnHTML;
            loadingSpinner.classList.remove('visible');
        }
    });

    function updateUI(data) {
        const { json, patient, clinician, overlay_url, orig_url, report_url } = data;
        const { predicted_label, confidence, triage = {}, image_quality = {}, detailed_analysis = {}, clinical_correlates = {} } = json;
        
        const category = predicted_label || 'Unknown';
        const triageLevel = triage.level || 'unknown';

        let badgeClass = 'bg-secondary';
        let alertClass = 'alert-secondary';
        switch (category) {
            case 'No DR': badgeClass = 'bg-success'; alertClass = 'alert-success'; break;
            case 'Mild': badgeClass = 'bg-info text-dark'; alertClass = 'alert-info'; break;
            case 'Moderate': badgeClass = 'bg-warning text-dark'; alertClass = 'alert-warning'; break;
            case 'Severe': badgeClass = 'bg-danger'; alertClass = 'alert-danger'; break;
            case 'Proliferative': badgeClass = 'bg-dark'; alertClass = 'alert-danger'; break;
        }

        const clinicianBulletsHTML = (clinician.bullets || []).map(b => `<li>${b}</li>`).join('');

        const top3PredictionsHTML = detailed_analysis.top_3_predictions ? Object.entries(detailed_analysis.top_3_predictions).map(([label, prob]) => {
            const percentage = (prob * 100).toFixed(1);
            return `<div class="mb-2"><div class="d-flex justify-content-between small"><span>${label}</span><strong>${percentage}%</strong></div><div class="progress" style="height: 10px;"><div class="progress-bar" style="width: ${percentage}%;"></div></div></div>`;
        }).join('') : '<p class="text-muted small">No prediction context available.</p>';

        const heatmapFindingsHTML = detailed_analysis.heatmap_findings ? `
            <li class="list-group-item px-0 d-flex justify-content-between"><span><b>Location:</b></span> <span>${detailed_analysis.heatmap_findings.location}</span></li>
            <li class="list-group-item px-0 d-flex justify-content-between"><span><b>Extent:</b></span> <span>${detailed_analysis.heatmap_findings.extent}</span></li>
            <li class="list-group-item px-0 d-flex justify-content-between"><span><b>Intensity:</b></span> <span>${detailed_analysis.heatmap_findings.relative_intensity}</span></li>
        ` : '<li class="list-group-item px-0 text-muted small">No specific area of interest was isolated.</li>';

        // --- NEW: Image Quality Score HTML ---
        const iqFlagsHTML = (image_quality.flags || []).map(flag => {
            const flagClass = flag === 'ok' ? 'bg-success' : 'bg-warning text-dark';
            return `<span class="badge ${flagClass} me-1">${flag.replace(/_/g, ' ')}</span>`;
        }).join('');
        const imageQualityHTML = `
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Quality Score</div>
                    <div class="fw-bold fs-4">${image_quality.score || 'N/A'}<small class="fs-6">/100</small></div>
                </div>
                <div><div class="small"><b>Flags:</b> ${iqFlagsHTML}</div></div>
            </div>
        `;

        resultsCard.innerHTML = `
            <div class="card-body p-4">
                <h5 class="fw-bold mb-2">Screening Result: <span class="badge fs-6 text-wrap ${badgeClass}">${category}</span></h5>
                <p class="text-muted mb-2">AI Confidence: <b>${confidence}%</b> (Adjusted for image quality)</p>
                <hr>
                ${imageQualityHTML}
                <div class="alert ${alertClass} p-3"><p class="mb-0 fw-bold">${patient.one_line || 'Summary not available.'}</p></div>
                <h6>Triage & Recommendation</h6>
                <div class="timeline my-3"><div class="timeline-step ${triageLevel}"><div class="ts-label">${triage.level?.toUpperCase() || 'N/A'}</div><div class="ts-text">${triage.timeframe || '-'} &bull; Refer to ${triage.who || '-'}</div></div></div>
                <hr>
                <div class="mt-4 mb-4">
                    <h6><i class="bi bi-robot me-2"></i>AI Detailed Analysis</h6>
                    <div class="p-3 border rounded bg-light mb-3"><p class="mb-0 small">${detailed_analysis.interpretation_summary || 'No detailed interpretation available.'}</p></div>
                    <div class="row g-4"><div class="col-md-6">
                        <strong class="small d-block mb-2">Prediction Context (Top 3)</strong><div>${top3PredictionsHTML}</div>
                    </div><div class="col-md-6">
                        <strong class="small d-block mb-2">Heatmap Findings</strong><ul class="list-group list-group-flush small">${heatmapFindingsHTML}</ul>
                    </div></div>
                </div>
                <hr>
                <div class="row g-3 mb-4">
                    <div class="col-md-6 text-center"><div class="image-box"><div class="image-label">Original</div><img src="${orig_url}?t=${Date.now()}" class="img-fluid border rounded"></div></div>
                    <div class="col-md-6 text-center"><div class="image-box"><div class="image-label">Highlighted Area of Interest</div><img id="overlayImgResult" src="${overlay_url}?t=${Date.now()}" class="img-fluid border rounded" style="opacity:0.8"></div>
                    <div class="mt-2 d-flex align-items-center justify-content-center gap-2"><small class="text-muted">Opacity</small><input id="opacityRangeResult" type="range" class="form-range w-50" min="20" max="100" value="80"></div></div>
                </div>
                <div class="mt-3 d-flex flex-wrap gap-2">
                    <a href="${report_url || '#'}" class="btn btn-sm btn-success" target="_blank"><i class="bi bi-file-earmark-arrow-down-fill me-1"></i>Download PDF Report</a>
                    <button id="toggleClinicianBtn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-card-text me-1"></i>Show Clinician Notes</button>
                </div>
                <div id="clinicianBoxResult" class="mt-4 p-3 border rounded bg-light" style="display:none;"><h6>Clinician Summary</h6><ul class="small mb-0">${clinicianBulletsHTML}</ul></div>
            </div>`;

        // --- NEW: Clinical Correlates Sidebar ---
        const correlatesPointsHTML = (clinical_correlates.points || []).map(p => `<li class="list-group-item">${p}</li>`).join('');
        contextualSidebar.innerHTML = `
            <div class="left-sidebar-sticky">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${clinical_correlates.title || 'Associated Clinical Signs'}</h6>
                        <p class="small text-muted">${clinical_correlates.disclaimer}</p>
                        <ul class="list-group list-group-flush">${correlatesPointsHTML}</ul>
                    </div>
                </div>
            </div>`;

        resultsCard.style.visibility = 'visible';
        resultsCard.classList.add('visible');
        document.getElementById('opacityRangeResult').addEventListener('input', (e) => { document.getElementById('overlayImgResult').style.opacity = (e.target.value / 100); });
        document.getElementById('toggleClinicianBtn').addEventListener('click', () => { document.getElementById('clinicianBoxResult').style.display = (document.getElementById('clinicianBoxResult').style.display === 'none') ? 'block' : 'none'; });
    }
</script>
</body>
</html>